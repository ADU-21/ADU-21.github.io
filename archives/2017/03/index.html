<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/styles.css"><title>归档：2017 年 3 月 | 杜屹东的博客</title></head><body><div class="container"><div class="columns page-header"><h1>杜屹东的博客</h1></div><div class="columns"><div class="navigation"><nav class="menus-main"><a href="/" class="favicon"><img alt="杜屹东的博客" src="/favicon.png"></a><a href="/about">关于我</a><a href="/list">日志列表</a><a href="/booklist">读书</a><a href="/links">链接</a><a href="/resume">简历</a></nav><nav class="right menus-right"><a target="_blank" href="https://github.com/ADU-21/blog">Fork on Github</a></nav></div></div><div class="columns"><div class="block-body column three-fourths"><div class="article-widget"><a href="https://www.duyidong.com/awsSolutionsArchitect_AE.pdf">AWS认证方案解决架构师证书</a></div><div class="article-widget"><strong>归档 2017 年 3 月</strong></div><article><header><h2><a href="/2017/03/23/AWS-well-architected-framework/">AWS well architected framework</a></h2></header><div class="article-meta clearfix"><time class="left">2017 3 月 23 日</time><ul class="tags left"></ul><ul class="tags right"><li><a href="/tags/AWS/">AWS</a></li><li><a href="/tags/Cloud-Native/">Cloud Native</a></li></ul></div><div class="markdown-body"><h1 id="AWS认为，什么样的架构是一个良好的架构"><a href="#AWS认为，什么样的架构是一个良好的架构" class="headerlink" title="AWS认为，什么样的架构是一个良好的架构"></a>AWS认为，什么样的架构是一个良好的架构</h1><p>AWS Well Architected framework，其实是亚马逊的一封<a href="https://d0.awsstatic.com/whitepapers/architecture/AWS_Well-Architected_Framework.pdf" target="_blank" rel="external">白皮书</a>，围绕云架构设计的安全性，可靠性，负载，花销，运维（2016年11月加入）五个支柱阐述了一个良好的架构应该遵循什么样的原则，以及一些最佳实践。<br>亚马逊在云服务届处于世界领先水平，且在十多年的云架构实践中已经积累了相当的经验，该白皮书是对这些经验的一个总结和提炼。不管是对于考试，对于成为一个云架构师，还是对于单纯的学习和了解云服务，都是一份不可多得的好材料。<br>下面附上资源地址：<a href="https://d0.awsstatic.com/whitepapers/architecture/AWS_Well-Architected_Framework.pdf" target="_blank" rel="external">https://d0.awsstatic.com/whitepapers/architecture/AWS_Well-Architected_Framework.pdf</a></p>
<h2 id="啰嗦几句"><a href="#啰嗦几句" class="headerlink" title="啰嗦几句"></a>啰嗦几句</h2><p>自从互联网诞生以来，各互联网公司通过将自己服务器的端口暴露在公共网络的方式提供服务，普通用户通过供应商接入公共网络，与公司服务器建立连接进行数据传输，从而实现“上网”的功能。对普通用户而言，终端以外的世界都是黑盒，而对于提供服务的互联网公司而言，则要运维大量的服务器，交换机等设备，为了保证服务的可靠性，容灾能力，为了开发，测试，常常需要维护超过实际提供服务的服务器数量很多倍的基础设施。又例如，在淘宝双十一期间可能由于用户访问量基层淘宝需要临时增加一倍的服务器数量来保证服务的正常运行，而在活动结束后，又需要恢复正常的服务器数量，那么这多出来的一倍服务器难免就会造成资源浪费。而且在很多时候，传统运维的背景下，申请一台服务器时间很长，手续繁琐，为了方便，研发部门通常会申请超出所需的基础设施资源，“以备不时之需”，这样的情况也会给企业造成大量的浪费。云服务，就是为了解决这种种问题而诞生的。</p>
<p><img src="/images/Cloud_better.png" alt=""></p>
<p>最简单的云服务模型，就是在云服务厂商集中托管了一个超级大型的服务器群，云服务厂商通过对外租赁服务器的形式代替了互联网厂商自己维护服务器的方式。这样做的好处在于一是避免了闲置基础设施资源的浪费，二是随着云服务的不断普及，以及Agile，DevOps运动的兴起，人们对IT设施的灵活度要求越来越高，这两年Infrastructure as Code（基础设施即代码）的理念已经被越来越多的厂商应用到生产实践中去，基础设施及代码的理念，和云服务是一脉相承的，租户可以更快地申请到设备，可以更灵活的对自己的设备定制化，规定大小，容量，甚至预配置一些环境，和自己的服务紧耦合，使公司的生产活动可以跟多的关注在业务上，而不用去操心服务器的性能，预估自己能承受的访问量，从而给业务发展带来更大的发展空间。这一点表现在今年AWS大力在推行的的Serverless架构上。<br>在笔者看来，云服务并不是一个技术上的创新，而更像是一种商业模式，为了让企业更灵活的适应瞬息万变的市场和用户需求，为了使社会资源更加合理化配置，同时，云服务也是信息全球化的重要一环，为人工智能，大数据奠定了基础。</p>
<h1 id="如何定义一个良好的架构"><a href="#如何定义一个良好的架构" class="headerlink" title="如何定义一个良好的架构"></a>如何定义一个良好的架构</h1><p>AWS从五大支柱来判定一个架构设计得是否优秀：</p>
<ul>
<li><strong>Security</strong>安全：保护信息，系统安全，在风险可控的前提下对外提供服务，以及迁移的策略</li>
<li><strong>Reliability</strong>可靠：系统的容错能力和自我修复能力，系统在负载增加时动态获取计算资源以满足业务需求，以及在系统模块发生故障时自动替换掉故障模块</li>
<li><strong>Performance Efficiency</strong>负载能力：根据系统需要，伸缩负载的能力</li>
<li><strong>Cost Optimization</strong>资费优化：在满足需求的情况下花尽可能少的钱</li>
<li><strong>Operational Excellence</strong>运维出色：业务连续性，系统状况监控预警能力</li>
</ul>
<h3 id="一般设计原则（General-Design-Principles）"><a href="#一般设计原则（General-Design-Principles）" class="headerlink" title="一般设计原则（General Design Principles）"></a>一般设计原则（General Design Principles）</h3><ul>
<li>停止估算需要多少基础设施，架构可以根据业务情况灵活伸缩</li>
<li>构建一个和生产环境完全一致的测试环境，你可以在测试环境完全模拟生产环境的情形，并在完成测试之后清理掉所有资源</li>
<li>自动化使架构变更的风险更低，基础设施及代码的好处，让架构可复制，架构变更变得可追踪，且减少了很多情况认为操作带来的风险</li>
<li>允许架构更灵活地变更，一是风险更低，因为变更可追溯，二是架构可以被及时回滚，三是彻底的变更成本很小</li>
<li>数据驱动型架构，灵活的架构方式允许你使用面向数居的架构方式</li>
<li>通过“game day”来提升架构，由于架构可以被轻易的复制且用户只需要按使用付费，租户可以在任意时候测试自己的架构是否存在安全漏洞，是否存在可以被改进的地方</li>
</ul>
<p>下面白皮书围绕以上提到的几大优秀架构的设计支柱，提出了一系列设计原则，最佳实践以及实践这些最佳实践可以用到的服务：</p>
<h2 id="安全（Security-Pillar）"><a href="#安全（Security-Pillar）" class="headerlink" title="安全（Security Pillar）"></a>安全（Security Pillar）</h2><h3 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h3><ul>
<li>在每一个层面引入安全：除了应用安全还应该在网络，负载均衡器，防火墙，操作系统关注安全</li>
<li>可追溯：保证系统的每一次操作/更改都被记录日志，并对日志进行审查</li>
<li>确保“最小权限原则”：确保每一个资源都被赋予了恰好需要的最小权限，实时审查这些权限，及时清理掉没用的权限</li>
<li>关注在你的系统安全：根据AWS的责任划分模型，关注在用户应该负责的系统安全和数据安全层面<br><img src="https://d0.awsstatic.com/security-center/NewSharedResponsibilityModel.png" alt=""></li>
<li>自动化安全最佳实践：使用基于应用层的策略保证安全问题能够被快速修复，例如，创建打好补丁的镜像，然后让所有之后创建的instance使用这个镜像；再例如，对常见安全问题自动响应和自动修复故障</li>
</ul>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>AWS将最佳实践划分为五个范畴：</p>
<ul>
<li>数据保护</li>
<li>认证和权限管理</li>
<li>架构保护</li>
<li>追踪控制</li>
<li>事件响应</li>
</ul>
<p>在设计你的架构之前，你需要知道谁可以对你的系统做什么，此外，你还希望确定判断每个发生在系统的事件是否安全，保护你的操作系统和服务，你需要维护和保密你的数据，你还需要做到系统对安全事件能够自动响应。</p>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><h4 id="数据保护"><a href="#数据保护" class="headerlink" title="数据保护"></a>数据保护</h4><p>确认只有必要的用户有访问部分数据的权限，确保数据在存储时被加密，传输过程中被加密，使用IAM，以下实践可以保证你的数据安全：</p>
<ul>
<li>AWS的用户享有对所有数据完全的控制权</li>
<li>AWS确保用户可以轻松对自己的数据进行加密，并提供方法管理加密所使用的key，并可以通过AWS或者用户自己定义的方式自动定期更换key（Key Management Service）</li>
<li>AWS允许开启详细的日志信息，包括文件的权限变更（CloudTrail）</li>
<li>AWS提供极高的可用性保证你的数据不会丢失（S3）</li>
<li>开启版本管理，可以作为数据生命周期的一部分，可以保护对数据的误操作</li>
<li>AWS默认不会对数据做跨Region的转移或备份，即数据不会离开它所在Region的“国家/城市”</li>
</ul>
<p>另外两个重要的问题：</p>
<ul>
<li>如何保证数据存储时加密？</li>
<li>如何确保数据传输过程的加密？（SSL）</li>
</ul>
<h4 id="认证和权限管理"><a href="#认证和权限管理" class="headerlink" title="认证和权限管理"></a>认证和权限管理</h4><p>通过亚马逊的AMI，租户可以完全控制根账户下每个用户，以及应用对所有资源的访问权限，确保每个User和Role只拥有必须的权限是必要的，同时确保每个资源只在被授权的情况下才能够被访问和使用。常见的权限管理包含以下内容：</p>
<ul>
<li>ACL（用于管理用户对于S3中存放对象的操作访问权限）</li>
<li>基于Role的权限控制</li>
<li>密码管理（定期更换密码）</li>
</ul>
<p>同样，几个问题：</p>
<ul>
<li>如何保证根账户的安全？（是否开启了第三方验证，是否删掉了Access Key）</li>
<li>如何保证User和Role的权限是安全的？（是否使用Group管理用户）</li>
<li>如何限制应用程序，脚本，或第三方工具对AWS资源的控制访问权限？</li>
<li>如何管理Key和证书？</li>
</ul>
<h4 id="架构保护"><a href="#架构保护" class="headerlink" title="架构保护"></a>架构保护</h4><p>通常来说架构保护指的是对本地数据中心的保护，在AWS的白皮书中主要提到的是对于VPC的保护，主要包括VPC中的Security Group，Network Control list，路由策略</p>
<p>几个问题：</p>
<ul>
<li>如何管理你的网络策略，和设备安全？（是否有内外网划分，在外网的Instance的登录验证是怎样的，有没有开启多重验证）</li>
<li>服务层面的安全管理？（多少用户有对你资源的访问权限，是否有对这些用户进行分组管理，是否对这些用户的验证进行了强行的限制，如强密码和定期更换密码，等等）</li>
<li>如何保证你的系统安全，如何运维监控你的服务？</li>
</ul>
<h4 id="追踪控制"><a href="#追踪控制" class="headerlink" title="追踪控制"></a>追踪控制</h4><p>以下服务可以用于设施变更的追溯及审查：</p>
<ul>
<li>CloudTrail，用于记录AWS API的每一次操作，并生成日志保存在S3中</li>
<li>Amazon CloudWatch，用于实时监控和预警</li>
<li>AWS Config</li>
<li>Amazon S3</li>
<li>Amazon Glacier</li>
</ul>
<p>常见问题：</p>
<ul>
<li>如何获取和分析你的日志？</li>
</ul>
<h3 id="涉及到的服务（Key-AWS-Services）"><a href="#涉及到的服务（Key-AWS-Services）" class="headerlink" title="涉及到的服务（Key AWS Services）"></a>涉及到的服务（Key AWS Services）</h3><ul>
<li>数据保护：加密数据存储和传输：ELB, S3 &amp; RDS</li>
<li>权限管理：IAM, MFA</li>
<li>架构保护：VPC, NCL, SG</li>
<li>追踪控制：CloudTrail, Config, CloudWatch</li>
</ul>
<h2 id="可靠性（Reliability-Pillar）"><a href="#可靠性（Reliability-Pillar）" class="headerlink" title="可靠性（Reliability Pillar）"></a>可靠性（Reliability Pillar）</h2><h3 id="设计原则-1"><a href="#设计原则-1" class="headerlink" title="设计原则"></a>设计原则</h3><ul>
<li>测试覆盖率</li>
<li>自动修复错误</li>
<li>水平扩展</li>
<li>停止猜测生产力</li>
<li>自动追踪架构变更</li>
</ul>
<h3 id="最佳实践-1"><a href="#最佳实践-1" class="headerlink" title="最佳实践"></a>最佳实践</h3><h4 id="建立基础"><a href="#建立基础" class="headerlink" title="建立基础"></a>建立基础</h4><p>在开始架构设计之前，选择Region，确立方案。</p>
<ul>
<li>如何管理AWS对服务数量的限制</li>
<li>如何设计网络拓扑</li>
<li>是否有预留空间用于处理技术难题</li>
</ul>
<h4 id="变更管理"><a href="#变更管理" class="headerlink" title="变更管理"></a>变更管理</h4><p>这里说的变更主要指的是架构的水平扩展</p>
<ul>
<li>如何根据业务需求进行系统变更</li>
<li>如何监控变更</li>
<li>如何执行变更（自动化）</li>
</ul>
<h4 id="容错管理"><a href="#容错管理" class="headerlink" title="容错管理"></a>容错管理</h4><ul>
<li>数据备份</li>
<li>灾难恢复</li>
<li>如何应对应用组件失效</li>
<li>如何对系统弹性进行测试</li>
</ul>
<h3 id="涉及到的服务"><a href="#涉及到的服务" class="headerlink" title="涉及到的服务"></a>涉及到的服务</h3><ul>
<li>建立基础：IAM, VPC</li>
<li>变更管理：CloudTrail</li>
<li>容错管理：CloudFormation</li>
</ul>
<h2 id="性能负载（Performance-Efficiency-Pillar）"><a href="#性能负载（Performance-Efficiency-Pillar）" class="headerlink" title="性能负载（Performance Efficiency Pillar）"></a>性能负载（Performance Efficiency Pillar）</h2><p>这一个支柱的核心思想是如何使用变更的计算资源来满足日益变化的业务需求</p>
<h3 id="设计原则-2"><a href="#设计原则-2" class="headerlink" title="设计原则"></a>设计原则</h3><ul>
<li>为用户隐藏更多的细节让用户可以轻松调度资源，更关注在产品的业务价值</li>
<li>数分钟内让服务发布到全球</li>
<li>使用无服务（Serverless）架构</li>
<li>更容易实验</li>
<li>使用最符合用户想要实现的技术方法。例如，在选择数据库或存储方法时考虑数据访问模式。</li>
</ul>
<h3 id="最佳实践-2"><a href="#最佳实践-2" class="headerlink" title="最佳实践"></a>最佳实践</h3><h4 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h4><ul>
<li>架构：数据驱动/事件驱动/ETL(数据仓储)/Pipeline，架构的选择决定了以下几种资源的选择</li>
<li>计算：Instance（type, monitor, quantity ）/Container/Function，同时要考虑到水平扩展能力</li>
<li>存储：涉及到存储服务选择（S3/S3 IA/S3 RRS/Glacier），存储介质选择（SSD/HDD）<ul>
<li>存储方式：块存储、文件存储、对象存储</li>
<li>访问方式：随机还是连续</li>
<li>吞吐量要求</li>
<li>访问频率：在线、离线、存档</li>
<li>更新频率：缓慢变更、动态实时更新</li>
<li>可用性限制</li>
<li>数据耐久度限制</li>
</ul>
</li>
<li>数据库：RDS/DynamoDB/Redshift</li>
<li>网络：考虑地址，网络延迟（是否需要PlacementGroup），在各服务组合方式中寻找合适的配置Cloudfront, VPC, DirectConnect, Route53</li>
</ul>
<h4 id="回顾审视"><a href="#回顾审视" class="headerlink" title="回顾审视"></a>回顾审视</h4><p>设计好一个架构，应该再次审视你的架构是如何配合业务需求的，以及随着业务的改变，当引入新的资源类型和功能时，如何确保继续拥有最合适的资源配置？</p>
<h4 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h4><p>如何监控服务器负载和性能</p>
<h4 id="时间空间的平衡"><a href="#时间空间的平衡" class="headerlink" title="时间空间的平衡"></a>时间空间的平衡</h4><p>如何用增加空间，冗余备份的方式提高系统响应速度，增加性能负载。最明显的例子就是利用Cloudfront将静态文件缓存到各个节点从而增加各个地区的访问速度</p>
<h3 id="涉及到的服务-1"><a href="#涉及到的服务-1" class="headerlink" title="涉及到的服务"></a>涉及到的服务</h3><ul>
<li>选择<ul>
<li>计算：Auto Scaling是关键，确保你拥有合适数量的Instance来满足业务需求</li>
<li>存储：EBS提供灵活多样的存储介质及参数，比如SSD, PIOPS，S3提供了静态文件交付方式，Amazon S3 Transfer Acceleration使用户可以远距离，快速，方便，安全的传输大文件</li>
<li>数据库： RDS（IOPS，Read Replicas）DynamoDB可以灵活扩展且提供毫秒级延迟的服务</li>
<li>网络：Route53可以提供根据地区延迟分发的路由策略，VPC endpoint(NAT, VPN, Direct Connect)开启灵活的网络互连</li>
</ul>
</li>
<li>回顾审视：<a href="https://aws.amazon.com/blogs/aws/" target="_blank" rel="external">AWS Blog</a>和<a href="https://aws.amazon.com/new/" target="_blank" rel="external">AWS What’s New section</a>可以看到AWS又推出了何种新服务</li>
<li>监控：AWS CloudWatch提供了不同维度(Metrics)的监控，触发事件(alarms)，以及提示(Notifications)，可以配合Lambda对监控事件作出反应</li>
<li>空间换时间：AWS ElastiCache，Cloudfront，Snowball，以及RDS的Read Replicas都是为了空间换时间的典型</li>
</ul>
<h2 id="费用优化（Cost-Optimization-Pillar）"><a href="#费用优化（Cost-Optimization-Pillar）" class="headerlink" title="费用优化（Cost Optimization Pillar）"></a>费用优化（Cost Optimization Pillar）</h2><h3 id="设计原则-3"><a href="#设计原则-3" class="headerlink" title="设计原则"></a>设计原则</h3><ul>
<li>采用消费模式：根据使用情况实时变更资源配置，而不是精确估计资源使用情况</li>
<li>收益与经济规模：因为AWS拥有比单个企业大得多的经济规模，可以在各个企业的需求之间平衡资源需求，所以价格将会更加便宜</li>
<li>停止在自建数据中心中的投入</li>
<li>分析支出：云使得资源利用率和成本更加透明，有助于企业主衡量投资回报率，并为用户提供优化资源降低成本的机会</li>
<li>托管服务降低成本</li>
</ul>
<h3 id="最佳实践-3"><a href="#最佳实践-3" class="headerlink" title="最佳实践"></a>最佳实践</h3><ul>
<li>更佳有效地利用资源</li>
<li>更贴近业务需求</li>
<li>支出意识：<ul>
<li>清楚地认识到哪些服务是会被收费的，收费方式怎样，哪些服务是免费的</li>
<li>监控支出</li>
<li>及时关闭不被使用的资源</li>
<li>给资源配置权限管理以控制花费</li>
</ul>
</li>
<li>随时优化</li>
</ul>
<h3 id="涉及到的服务-2"><a href="#涉及到的服务-2" class="headerlink" title="涉及到的服务"></a>涉及到的服务</h3><ul>
<li>有效利用资源：对于EC2，申请预留实例以减少开销，使用 AWS Trusted Advisor 找到可以减少花费的方式</li>
<li>贴近业务需求：Auto Scaling</li>
<li>支出意识：CloudWatch用于监控花费情况，SNS用于提示超出预算的花费</li>
<li>随时优化：<a href="https://aws.amazon.com/blogs/aws/" target="_blank" rel="external">AWS Blog</a>和<a href="https://aws.amazon.com/new/" target="_blank" rel="external">AWS What’s New section</a>以及 AWS Trusted Advisor </li>
</ul>
<h2 id="运维出色（Operational-Excellence-Pillar）"><a href="#运维出色（Operational-Excellence-Pillar）" class="headerlink" title="运维出色（Operational Excellence Pillar）"></a>运维出色（Operational Excellence Pillar）</h2><p>运维出色应该是AWS配合DevOps运动推出的一系列实践：</p>
<h3 id="设计原则-4"><a href="#设计原则-4" class="headerlink" title="设计原则"></a>设计原则</h3><ul>
<li>使用代码执行运维操作：运维的一个发展趋势是越来越自动化，比如我们可以用自动配置管理工具配置更改环境，响应实践等</li>
<li>强调配合业务需求的运维：将运营流程与业务目标相一致，减少不必要的运维指标</li>
<li>定期，小步，增量式的运维：工作负载应设计为允许组件定期更新，运维的更新也应该小步前进，且容易被回滚，在维护和更换组件时不应造成宕机时间</li>
<li>启用测试以对运维的误操作及时响应：对于组件更替和运维的操作应该有测试，及时发现变更错误以便于修复或回滚</li>
<li>在错误中学习：定期回顾对运维事件的处理方法以改进，持续推动卓越运维</li>
<li>保持操作流程：团队之间相互学习，及时更新文档，保证团队运维操作有统一流程，统一的运维方式</li>
</ul>
<h3 id="最佳实践-4"><a href="#最佳实践-4" class="headerlink" title="最佳实践"></a>最佳实践</h3><ul>
<li>准备：何种最佳实践？选用何种配置管理？</li>
<li>开始作业：如何小步前进，如何监控每一次运维操作？</li>
<li>响应：如何对计划之外的运维操作做出响应？</li>
</ul>
<h3 id="涉及到的服务-3"><a href="#涉及到的服务-3" class="headerlink" title="涉及到的服务"></a>涉及到的服务</h3><ul>
<li>准备：AWS Config，AWS Service Catalog，使用Auto Scaling和SQS来保证运维的连续性</li>
<li>作业：这一部分主要是CI/CD: AWS CodeCommit, AWS CodeDeploy, and AWS CodePipeline</li>
<li>响应：CloudWatch alarm</li>
</ul>
<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><p>可以看到AWS对于优秀网站的设计，除了一般要求的可靠，省钱，还根据云服务的基础设施可灵活变更的特点强调了水平扩展和架构灵活变更，以更好地满足业务需要，保证<code>业务连续性</code>(business continuity)<br>白皮书最后还给出了FAQ（Frequently asked questions）部分回答了一些关于最佳实践的常见问题，非常值得一看。</p>
</div></article><article><header><h2><a href="/2017/03/20/Enable-HTTPS-and-CDN-with-Cloudfront/">Enable HTTPS and CDN with Cloudfront</a></h2></header><div class="article-meta clearfix"><time class="left">2017 3 月 20 日</time><ul class="tags left"></ul><ul class="tags right"><li><a href="/tags/AWS/">AWS</a></li><li><a href="/tags/Blog/">Blog</a></li><li><a href="/tags/HTTPS/">HTTPS</a></li><li><a href="/tags/CDN/">CDN</a></li><li><a href="/tags/Cloudfront/">Cloudfront</a></li><li><a href="/tags/Route53/">Route53</a></li></ul></div><div class="markdown-body"><h1 id="使用AWS解锁HTTPS和CDN"><a href="#使用AWS解锁HTTPS和CDN" class="headerlink" title="使用AWS解锁HTTPS和CDN"></a>使用AWS解锁HTTPS和CDN</h1><p>在上一篇博客中，笔者已经介绍了<a href="https://www.duyidong.com/2017/03/07/Deploy-Hexo-to-S3/">将hexo博客发布到S3</a>，这一部分我将介绍如何使用AWS的Route53应用上自己的域名，以及如何使用Cloudfront开启HTTPS/HTTP2和CDN加速。</p>
<h2 id="关于Route53"><a href="#关于Route53" class="headerlink" title="关于Route53"></a>关于Route53</h2><p>Route53是AWS提供的DNS服务，提供常见域名服务，用户可以使用Route53注册使用域名，指向自己的服务，可以除了一般域名服务都支持的A类地址（直接指向IP），及CNAME（指向另一个域名）以外，Route53还支持一个功能叫做A-record，即可以将DNS指向AWS内部的资源，该服务功能与CNAME基本相同，但是免费。此外，Route53支持以下几种路由策略：</p>
<ul>
<li><strong>Simple Routing Policy</strong>：通常在只有一个资源的时候使用这种策略，该种策略会自由（平均）分配负载给所属资源</li>
<li><strong>Weighted Routing Policy</strong>：加权路由，这种路由策略支持用户指定的路由百分比，比如百分之20的流量导入测试环境，百分之80的流量导入产品环境，用于进行AB测试。</li>
<li><strong>Latency Routing Policy</strong>：该种策略会根据客户端访问的延迟情况选择合适的服务，比如一个客户访问A延迟为20毫秒，访问B服务延迟为250毫秒，那Latency Routing就会把该用户的访问导入A服务。</li>
<li><strong>Failover Routing Policy</strong>：该路由策略在其中一个被路由资源宕机的情况下会停止流量引入，从而避免用户访问到错误页面，这里涉及到Route53的另一个功能———健康检查。</li>
<li><strong>Geolocation Routing Policy</strong>：地理位置策略允许用户设置将不同地理位置的用户流量导入到不同服务，例如希望悉尼的用户和北京的用户在一个网站上看到不同的页面，可以采用这种路由方式。</li>
</ul>
<h2 id="关于Cloudfront"><a href="#关于Cloudfront" class="headerlink" title="关于Cloudfront"></a>关于Cloudfront</h2><p>Cloudfront是AWS的CND服务，利用AWS分布在全球的节点服务器（Edge Location）缓存用户的访问，用户在第二次访问（或同区域的另一个用户在非首次访问）页面时会直接从节点服务器取到已经缓存的数据，速度会大大加快。<br>同理，Cloudfront也可以用于文件上传。</p>
<h2 id="申请Route53和Cloudfront权限"><a href="#申请Route53和Cloudfront权限" class="headerlink" title="申请Route53和Cloudfront权限"></a>申请Route53和Cloudfront权限</h2><p>默认情况下，所有账户都是没有开启Cloudfront和Route53服务的，这个时候需要使用账号注册邮箱发送邮件到<a href="aws-verification@amazon.com">aws-verification@amazon.com</a>申请开通。</p>
<h2 id="申请域名"><a href="#申请域名" class="headerlink" title="申请域名"></a>申请域名</h2><p>得到服务使用权限之后，还需要申请一个域名，这个时候可以在AWS的<a href="https://console.aws.amazon.com/cloudfront/route53" target="_blank" rel="external">Route53</a>进行购买，也可以在阿里云的<a href="https://wanwang.aliyun.com/domain/" target="_blank" rel="external">万网</a>注册一个域名，域名会按使用年数收费，不同域名收费不同。<br>在亚马逊购买域名，只需要进入<a href="https://console.aws.amazon.com/route53/home" target="_blank" rel="external">Console</a>，在<strong>Register Domain</strong>栏输入你想要的域名，点选Check，接下来如果域名可用，可以Add to Card然后付费即可。大约一小时后，这个域名就可以被使用了。</p>
<p><img src="/images/Route53_Register_Domain.png" alt=""></p>
<h2 id="配置Cloudfront"><a href="#配置Cloudfront" class="headerlink" title="配置Cloudfront"></a>配置Cloudfront</h2><p>点击<strong>Create Distribution</strong>按钮，Delivery method选择Web。 Web主要针对一些html，css,js等静态文件，而RTMP则主要是一些音视频文件。点选“Get Start”。</p>
<p><img src="/images/Clouldfront_Configure_Select_Delivery_Method.png" alt=""></p>
<p>下一步，要选择Origin,即要进行内容分发的源。虽然亚马逊会自动列出你的S3 bucket，但是千万不要选。而是自己手动输入example.com这个Bucket的Endpoint(Endpoint在S3 Console的Properties标签下的Static Website hosting里看得到)。为什么不直接选S3 bucket那?这是因为当我们访问一个目录时，我们期望能返回默认的object。虽然CouldFront有个Default Root Object设置，只是对根目录起作用，对子目录不起作用。如果使用Bucket的Endpoint，再加上之前已经给该Bucket配置了Default Object，就可以解决这个问题。</p>
<p><img src="/images/Clouldfront_Configure_Origin_Domain_Name.png" alt=""></p>
<p>选择将HTTP重定向到HTTPS，在CNAMEs项中输入自己的域名，多个域名以逗号分隔。<br>在Distribution Setting下选择你自己的证书(如果没有可以点选Request or Import a Certificate with ACM免费申请)。</p>
<p><img src="/images/Clouldfront_Configure_Distribution_Setting.png" alt=""></p>
<p>[可选]勾选Logging，并选择Bucket for Logs，可以打印访问信息。由于是静态网站，Cookie的Log就没有必要了。</p>
<p><img src="/images/Clouldfront_Configure_Logging.png" alt=""></p>
<p>点选<strong>Create Distribution</strong>，创建成功，需要等待大约半小时等待Status从<code>In progress</code>变为<code>Deployed</code>，在这期间可以配置Route53。</p>
<p><img src="/images/Clouldfront_Configure_Success.png" alt=""></p>
<p>配置成功后可以在管理员面板修改所有创建Distribution时设置的参数，并可以增加Error Page等设置。</p>
<p><img src="/images/Clouldfront_Configure_Admin.png" alt=""></p>
<blockquote>
<ul>
<li>注意：Cloudfront的配置每次更改都需要从新部署，每次重新部署都需要大约半小时时间，为了避免不必要的时间浪费，最好是一次配置成功，不然真的很痛苦。。</li>
<li>另外，关于Cloudfront的日志，AWS不会针对日志功能进行收费，但用户需要对占用的S3 bucket存储和访问付费，日志内容大概和Nginx的access.log差不多，个人觉得AWS的<a href="https://console.aws.amazon.com/cloudfront/home#cache_stat_reports" target="_blank" rel="external">Reports &amp; Analytics</a>已经做得很好了，日志有些多余，建议可以在学习完后关闭。</li>
</ul>
</blockquote>
<h3 id="关于缓存时间"><a href="#关于缓存时间" class="headerlink" title="关于缓存时间"></a>关于缓存时间</h3><p>关于S3里的Object在Cloudfront的各节点缓存的时间，默认为24小时，也就是说当我发布一篇新博客，由于主页index.html名字没有变化，只是更新了新版本，我要等到24小时后旧版本过期才能看到新的页面，这对我的小博客来说时间太长了，需要更改这个Cache时间，更改Cache时间有两种方式，一是更改TTL（Time To Live）时间，二是增加<code>Cache-Control: max-age=[seconds]</code>的heaeder，关于第二种方式，具体参见<a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Expiration.html#expiration-individual-objects" target="_blank" rel="external">官方文档</a>，这里我说一下如何更改TTL：<br>进入Distribution的管理员界面，选择<strong>Behaviors</strong>标签，勾选待编辑的Behavior，点选<strong>Edit</strong></p>
<p><img src="/images/Cloudfront_Distributions_Behaviors.png" alt=""></p>
<p>在Edit Behavior页面Object Caching项目勾选<strong>Customize</strong>自定义TTL，将Default TTL改为3600（1小时）点选<strong>Yes，Edit</strong>即可。<br>同样，更新配置要等待半小时左右方能生效。</p>
<blockquote>
<ul>
<li>参见 <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Expiration.html" target="_blank" rel="external">Specifying How Long Objects Stay in a CloudFront Edge Cache (Expiration)</a></li>
</ul>
</blockquote>
<h4 id="首页缓存时间"><a href="#首页缓存时间" class="headerlink" title="首页缓存时间"></a>首页缓存时间</h4><p>更改TTL后，首页的更新也需要一个小时，对大部分情况来说这个时间还是比较长，这个时候可以通过更改S3的Bucket里面的Object的Metadata的方式增加<code>Cache-Control</code>的Header来进一步减少首页的Cache时间。</p>
<p><img src="/images/Cloudfront_S3_Metadata.png" alt=""></p>
<blockquote>
<ul>
<li>这个手动的设置会在每次Deploy的时候被覆盖，所以需要给Deploy插件增加Update Metadata/Header的设置。</li>
</ul>
</blockquote>
<h3 id="如何清除缓存"><a href="#如何清除缓存" class="headerlink" title="如何清除缓存"></a>如何清除缓存</h3><h2 id="配置Route53"><a href="#配置Route53" class="headerlink" title="配置Route53"></a>配置Route53</h2><p>进入Route53的<a href="https://console.aws.amazon.com/route53/home" target="_blank" rel="external">Console</a>，进入<strong>Hosted Zones</strong>标签，点选使用的Domain Name。</p>
<p><img src="/images/Route53_Host_Zones.png" alt=""></p>
<p>点选<strong>Create Record Set</strong>，输入二级域名下的三级域名（可以置空），选择Type为A类地址，选择一个A-record），在AWS的内部资源中选择Cloudfront下对应你博客的域名，Route Policy为默认的Simple即可，点选<strong>Save Record Set</strong></p>
<p><img src="/images/Route53_Create_Record_Set.png" alt=""></p>
<p>只需要数分钟，A-record即可生效。</p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>现在可以通过HTTPS访问我在每个Edge Location缓存的博客了：</p>
<p><a href="https://www.duyidong.com">https://www.duyidong.com</a></p>
<p>经测试，同一个页面在加上Cloudfront之前（在S3 bucket中）访问时间是11秒，使用gitHub.io(带CDN)是6秒，使用Cloudfront之后加载时间大概是2.4秒，可见Cloudfront的加速效果是非常理想的。</p>
<blockquote>
<ul>
<li>参考资料</li>
<li><a href="https://www.huangbowen.net/blog/2013/10/01/migrate-octopress-to-aws-step-2/" target="_blank" rel="external">https://www.huangbowen.net/blog/2013/10/01/migrate-octopress-to-aws-step-2/</a></li>
<li><a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-policy.html" target="_blank" rel="external">https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-policy.html</a></li>
<li><a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Expiration.html" target="_blank" rel="external">https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Expiration.html</a></li>
</ul>
</blockquote>
</div></article><article><header><h2><a href="/2017/03/15/AWS-EC2/">AWS EC2</a></h2></header><div class="article-meta clearfix"><time class="left">2017 3 月 15 日</time><ul class="tags left"></ul><ul class="tags right"><li><a href="/tags/AWS/">AWS</a></li><li><a href="/tags/EC2/">EC2</a></li></ul></div><div class="markdown-body"><h1 id="AWS虚拟机EC2"><a href="#AWS虚拟机EC2" class="headerlink" title="AWS虚拟机EC2"></a>AWS虚拟机EC2</h1><p>Amazon Elastic Cloud Compute，简单来说就是亚马逊的虚拟机。<br>亚马逊的EC2标榜有几大优势：完全控制，灵活使用，方便集成，安全，便宜，简单好用。<br>关于EC2有几个重要的概念：Instance Type，即在选择Instance的时候的内存，CUP等硬件指标；然后是EBS，即挂载硬盘，租户可以选择不同IO，不同介质的虚拟硬盘；其次是AMI，即用于启动虚拟机的操作系统镜像；另外还有Security Group，可以理解为虚拟机的防火墙；其他的服务都属于附加服务，比如负载均衡，弹性伸缩，监控报警，权限控制，类似nfs的弹性存储介质等等。<br>虚拟机服务是云服务最重要的服务，几乎各大云厂商最终要的一项都是对租户提供虚拟机，看大厂的虚拟机策略，其他各厂基本可通晓一二。<br>由于企业级应用很少用windows的使用场景，笔者将主要关注在Linux的使用上，本文对windows使用场景改不涉及。</p>
<h2 id="Instances"><a href="#Instances" class="headerlink" title="Instances"></a>Instances</h2><p>EC2为亚马逊的服务，Instance就是该服务提供的一个实例 —— 虚拟机</p>
<h3 id="Instance-Purchasing-Options"><a href="#Instance-Purchasing-Options" class="headerlink" title="Instance Purchasing Options"></a>Instance Purchasing Options</h3><p>在说Instance Type之前，有个更重要的东西：Instance的收费方式（Instance Purchasing Options）。Instance有四种收费方式，针对不同应用场景要学会选择适合的Purchasing Option:</p>
<ul>
<li><strong>On-Demand Instance</strong> 按小时收费，也是默认的收费方式，不足一小时按一小时计费；属于比较灵活的按需付费方式</li>
<li><strong>Reserved Instances</strong> 预留实例，可选1-3年，一次付费，完成付费之后不管是否使用都会收费，价格相对按小时计费要便宜些，企业作为服务器长期使用通常会选择使用的付费方式</li>
<li><strong>Scheduled Reserved Instances</strong> 计划预留实例，为期一年，在计划时间内可用。值得注意的是，只有几个高性能的Instance Type支持该购买方式，且每年使用不得少于1200小时，需提前三个月购买</li>
<li><strong>Spot Instances</strong> 竞价实例，价格随时间浮动，租户在申请时出价，当租户出价高于该时间点竞价实例价格时，租户获得该实例使用权，当价格再次浮动导致实例价格高于租户出价，亚马逊会提前十分钟提醒租户，而后terminate实例，转移到别的地方。注意，被亚马逊销毁的实例最后一小时不收费，而用户在使用期间自行销毁的实例，不足一小时仍以一小时计费。这种收费方式适用于不需长期提供稳定服务的应用场景，比如大数据流处理。</li>
<li><strong>Dedicated hosts</strong>买下一个跑在固定物理设备上的Instance的使用权，保证租户的licenses不会因为不同物理设备过期。</li>
<li><strong>Dedicated Instances</strong>按小时计费的Dedicated hosts</li>
</ul>
<h3 id="Instances-Type"><a href="#Instances-Type" class="headerlink" title="Instances Type"></a>Instances Type</h3><p><a href="https://aws.amazon.com/ec2/instance-types/" target="_blank" rel="external">Instance Type</a>有10种类型，用于区分大致的应用场景，每个类型下有从nano, micro, small, medium, large, xlarge到16xlarge数目不等的型号，主要区分CPU数量，vCPU(亚马逊创造的用于衡量单个CPU运算能力的一个参数)，内存，不同，大小、类型不同，直接影响价格。</p>
<p><img src="/images/AWS_Instances_Type.png" alt=""></p>
<ul>
<li>D2 - Dense storage Instance，特点是硬盘价格平衡，支持HDD硬盘，支持EC2 Enhanced Networking，适用于对存储需求比较高的场景，比如数据库，大数据存储</li>
<li>R4: 特点是内存大</li>
<li>M4: 各项平衡的一个Instance类型，也是默认情况下首选的Instance Type</li>
<li>C4 - Compute Optimized: 计算能力优化，特点自然是计算速度快</li>
<li>G2: 包含GPU的Instance，适合于图形计算，视频转码等场景</li>
<li>I3 - High I/O Instance，高硬盘IO，使用固态硬盘，适用于非关系型数据库，大数据处理等</li>
<li>F1 - 可以为程序定制硬件加速</li>
<li>T2: 最常见的Instance使用类型，因为它最便宜，性能也最平衡，生产环境只适用于做web服务器，或小型数据库</li>
<li>P2: 通用GPU计算机，常用于人工智能等需要大量计算的领域</li>
<li><p>X1: CPU，内存都相当大，针对大规模，企业级，内存应用程序进行了优化，并且在Amazon EC2实例类型中具有每GiB最低的RAM价格</p>
<p>Instance类型在创建后可以被更改，前提是Stop Instance</p>
</li>
</ul>
<h3 id="Instance-LifeCycle"><a href="#Instance-LifeCycle" class="headerlink" title="Instance LifeCycle"></a>Instance LifeCycle</h3><p>Instance的生命周期，有pending, running, stop ,terminate几个主要的状态和动作，详见下图：</p>
<p><img src="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/images/instance_lifecycle.png" alt=""></p>
<h3 id="MetaData-amp-UserData"><a href="#MetaData-amp-UserData" class="headerlink" title="MetaData &amp; UserData"></a>MetaData &amp; UserData</h3><p>UserData是创建完成Instance最后一步用来准备Instance环境的Bash脚本，而MetaData是Instance与生俱来的元数据，通过<code>curl https://169.254.169.254/latest/meta-data/</code>这种奇特的方式获得，包含Instance类型，IP，public-key等信息。值得一提的是IAM的Role之所以在Instance的文件系统中不会出现Credential key的文件，是因为它把Credential key放到了MetaData中，可以通过获取MetaData的方式获得。</p>
<h2 id="EBS"><a href="#EBS" class="headerlink" title="EBS"></a>EBS</h2><p>简单来讲，EBS(Elastic Block Storage)就是AWS为租户提供的虚拟硬盘，Instance可以看做主板，EBS可以被关联到任何一个Instance上，启动Instance时也必须要一个启动硬盘作为系统盘才能启动。这里就要区分一个重要的概念，EBS 和 Instance Store，两种类型的Instance，应该说EBS Instance比Instance Store 更健全一些，支持更多的Instance Type，生命周期完整；而Instance Store，是由存放在S3的文件系统启动的，启动速度慢，生命周期不完整，只能被Reboot或者Terminate，不能Stop，一旦启动失败就会丢失所有数据，且支持类型有限，被称为短暂存储（ephemeral Storage）<br>下面重点区分一下<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSVolumeTypes.html" target="_blank" rel="external">EBS Volum Type</a>，与Instance相同，重点也在使用场景和节省开销：</p>
<ul>
<li>SSD, General Purporse - <strong>gp2</strong>: 兼顾性能与价格，吞吐量160MB/s，最大IOPS为10,000; 挂载卷大小在1GB-16TB；使用场景：推荐使用在大部分场景，虚拟机启动磁盘，提供低延迟的服务，可在开发测试环境应用</li>
<li>SSD, Provisioned IOPS - <strong>io1</strong>: 高性能磁盘，吞吐量320MB/s，IOPS在10,000-20,000; 挂载卷大小在4GB-16TB；使用场景：执行紧急任务的应用模块，大数据库，比如MongDB, Orale, SQL Server等</li>
<li>HDD, Throughput Optimized HDD - <strong>st1</strong>: 价格相对便宜的机械硬盘，用于存放不常使用的数据，IOPS最大仅500，吞吐量可达500MB/s，磁盘大小为500GB-16TB；使用场景：需要高吞吐量量有需要控制预算的场景，比如大数据，日志存放；不能用作启动磁盘</li>
<li>HDD, Code HDD - <strong>sc1</strong>: 比普通机械硬盘更便宜的磁盘，IOPS仅为250，吞吐量250MB/s，容量500GB-16TB，使用场景：非常强调便宜的不常访问数据的存储</li>
<li>HDD, EBS Magnetic - <strong>standard</strong>: 磁带存储，非常便宜的低频次访问的磁盘，性能最次（40-200IOPS, 40-60MB/s吞吐）</li>
</ul>
<blockquote>
<p>注：以上参数均需在Instance类型的支持才能发挥到最大值，机械硬盘的优势在于高吞吐，固态硬盘的好处在于高IO；另外一个需要注意的是，你可以在一个Instance上绑定多个EBS，但是不能将一个EBS绑定在多个Instance上（这种情况要使用EFS）</p>
</blockquote>
<h2 id="Security-Group"><a href="#Security-Group" class="headerlink" title="Security Group"></a>Security Group</h2><p>Security Group可以理解为Instance的防火墙，在Instance的网络中大概处在以下位置：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1765038-d1edcf22e1e4784c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>SG的安全策略大范围分为Inbound和Outbound，顾名思义为控制进出，SG刚被创建时默认所有Inbound都是被禁止的，所有Outbound都是被允许的。<br>SG由数条规则（rules）构成，Rules有几个重要参数：目标地址（网段），协议类型，端口号。<br>关于SG有以下几个值得注意的点：</p>
<ul>
<li>SG策略在修改后立即生效</li>
<li>一个SG可以被绑定到任意数量的Instance上</li>
<li>一个Instance可以有多个SG，且被允许的Rules为多个SG的合</li>
<li>SG是有状态的，也就是说当租户允许了一个请求进入，默认会打开到目的地址的返回请求</li>
<li>通常情况我们不适用SG的Rules来组织IP访问，组织IP访问应该用ACL(Access Control List)</li>
<li>SG只能添加允许访问的策略，不能添加禁止访问的策略</li>
</ul>
<h2 id="Volumse-amp-Snapshots"><a href="#Volumse-amp-Snapshots" class="headerlink" title="Volumse &amp; Snapshots"></a>Volumse &amp; Snapshots</h2><p>关于Volume Type，已经在EBS部分提到了，这里主要想讲的是磁盘的生命周期。<br>Volume可以从EBS创建，Attache到一个Instance上，再在操作系统中进行挂载，使其成为一个可用的文件系统，Volume可以随时扩容，但扩容后需要更新文件系统。<br>Volume可以凭空创建，也可以使用Snapshot创建，Snapshot就是磁盘的一个镜像，存放于S3中，用于定期备份磁盘。Snapshot是增量式的，也就是说只有被更改的部分会被记录在S3中。<br>第一个Snapshot的创建会比较花时间。<br>Snapshot可以通过S3在账户之间共享。<br>可以开启自动备份定时备份Volume。<br>EBS可以被加密，除了root Volume，租户可以使用第三方工具对启动磁盘进行加密。<br>另外说一下关于Windows卷扩容，需要停止磁盘读写，有以下措施可以做到：</p>
<ul>
<li>冻结文件系统</li>
<li>卸载磁盘驱动（Unmount the RAID Array）</li>
<li>关闭关联的EC2 Instance</li>
</ul>
<blockquote>
<p>注：一个EBS可以被创建10,000个Snapshot，一个账户可以拥有的Volume存储大小总量单个类型不得超过20TB</p>
</blockquote>
<h2 id="AMI"><a href="#AMI" class="headerlink" title="AMI"></a>AMI</h2><p>既然有了Snapshot，另一个重要的概念就不得不提了，AMI，Amazon Machine Image，可以理解为虚拟机的启动镜像。一个AMI包含了在云上启动一个实例所需的所有信息，包括：</p>
<ul>
<li>一个Root Volume的模板（比如一个操作系统，一个应用）</li>
<li>启动许可（在启动时用于判断该用户是否有从该AMI启动实例的权限）</li>
<li>启动实例时需要挂载的磁盘映射表</li>
</ul>
<p>一个AMI的生命周期看起来像是这个样子的：</p>
<p><img src="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/images/ami_lifecycle.png" alt=""></p>
<p>AMI是划分Region的，租户可以通过Console或CLI在Region之间拷贝AMI。<br>AMI可以用于在<a href="https://aws.amazon.com/marketplace/search/results?x=0&amp;y=0&amp;searchTerms=&amp;page=1&amp;ref_=nav_search_box" target="_blank" rel="external">AWS Marketplace</a>出售。</p>
<p>AMI依赖于Snapshot缺不被Instance依赖，这意味着租户不能删除一个被注册的AMI的Snapshot，却可以删除一个运行中实例的AMI，Snapshot，AMI，Instance的关系如下图:<br><img src="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/images/ami_delete_ebs.png" alt=""></p>
<h2 id="ELB-amp-Health-Checks"><a href="#ELB-amp-Health-Checks" class="headerlink" title="ELB &amp; Health Checks"></a>ELB &amp; Health Checks</h2><p>ELB，Elastic LoadBalancer是构建一个高可用可用不得不谈的服务，经常和Autoscaling Group一起实现负载伸缩和高可用。<br>ELB是AWS提供的负载均衡器，用于将外部访问请求分发给状态健康的EC2 Instance。<br>ELB在创建的时候会有对外会有一个DNS解析域名，对所属Instance会做健康检查，所谓健康检查就是去定期访问一个文件，判断返回状态码为200即表明这个服务正常，Instance可以动态地被加载到ELB下，也可以动态移除，ELB会自动判断这个Instance已经失去连接并停止发送请求到这个Instance。<br>值得一提的是，ELB一个重要的功能是增加服务容灾性，通常会挂载多个不同AZ的Instance，做到一个数据中心挂掉仍然能够正常提供服务。</p>
<h2 id="Cloud-Watch-EC2"><a href="#Cloud-Watch-EC2" class="headerlink" title="Cloud Watch EC2"></a>Cloud Watch EC2</h2><p>CloudWatch是AWS提供的EC2监控报警的服务，简单好用。<br>作为一款与AWS各种资源高度集成且简单好用的监控工具，CloudWatch有以下功能：</p>
<ul>
<li>构建Dashboard用于可视化云环境资源状况</li>
<li>警告：配合SNS在某项指标超出一定阈值时发出邮件或短信通知</li>
<li>事件：监控事件用于动态变更云设施</li>
<li>日志：日志保存在S3中</li>
</ul>
<p>CloudWatch的一些类目默认情况是免费的，免费版本是5分钟取回一次数据，收费后变成1分钟一次，且部分metrics需要收费才能监控。默认监控的内容包括CPU，网络，硬盘IO等，但是没有内存。</p>
<h2 id="Autoscaling-Group"><a href="#Autoscaling-Group" class="headerlink" title="Autoscaling Group"></a>Autoscaling Group</h2><p>一个Autoscaling Group包含多个特性相同的Instance，可以根据Instance的负载自动扩容或缩减，同时可以对Instance开启健康检查，如果一个Instance服务异常，Group会依照Lunch Configuration重新启动一个实例替换掉旧的实例。这种方式保证了Group内的Instance总是健康的，且Instance数目会根据负载情况进行动态伸缩。</p>
<h2 id="Placement-Group"><a href="#Placement-Group" class="headerlink" title="Placement Group"></a>Placement Group</h2><p>Placement Group是一个在同AZ中的一组Instance，同PG的Instance可以享受到高带宽，低延迟的好处，但同时也有如下限制：</p>
<ul>
<li>一个Placement Group不能跨多个AZ</li>
<li>一个Placement Group的名字必须在一个账号中是独一无二的</li>
<li>Placement Group只支持一部分类型的Instance</li>
<li>AWS推荐在一个PG中使用同质的Instance</li>
<li>PG不能被合并</li>
<li>租户不能移动一个已经存在的Instance到一个PG中，可以对这个Instance创建AMI，再使用这个AMI在PG中启动一个Instance</li>
</ul>
<h2 id="EFS"><a href="#EFS" class="headerlink" title="EFS"></a>EFS</h2><p>EFS是AWS提供可以再Instance之间贡献的一个NFS server，其最大的优点是不需要预先设置大小，其空间大小会随文件写入增多逐步扩容至PB级别，而租户只需按使用收费。<br>EFS可以支持上千个NFS4连接，适用于大数据存储，Web服务器静态文件共享，等诸多应用场景。<br>AWS目前有4个Region支持EFS，EFS的文件存放在多个AZ中，可以跨AZ共享文件。</p>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><ul>
<li>每个账户默认被限制可以申请20个保留实例，增加上限需要给亚马逊提Request</li>
<li>使用EC2发送邮件数量是有限制的</li>
<li>每个账户最多可申请5个Elastic IP</li>
<li>不同账户标记的一个AZ名字（比如us-east-1a）可能指向不同的物理数据中心</li>
<li>要使用增强网络型实例（Enhanced Network）租户不需要另外付费，只需要选择适当的AMI和适当的Instance类型在一个VPC中即可</li>
<li>默认情况下，当租户停止监控EC2实例或销毁了实例，两周内仍可访问CloudWatch的数据</li>
<li>如果删掉一个Auto Scaling Group，其中的Instance会先被销毁</li>
<li>租户可使用VM Import/Export从EC2导入/导出虚拟机镜像</li>
<li>虽然Snapshot被存在S3中，但租户不能通过S3的API访问到Snapshot，而只能通过EC2的API访问</li>
<li>分享Snapshot给特定的账户，Snapshot的状态仍为“private”</li>
</ul>
</div></article><div class="archive-pagination"><div class="paginator"><span class="page-number current">1</span><a class="page-number" href="/archives/2017/03/page/2/">2</a><a class="extend next" rel="next" href="/archives/2017/03/page/2/">&raquo;</a></div></div></div><div class="block-sidebar column one-fourth"><div class="widget text-content"><p>杜屹东 生于 1993.12.16, 英文 ID Luke Du</p>
<ul>
<li>现就职于<a href="https://www.thoughtworks.com/">ThoughtWorks</a></li>
<li>毕业于 <a href="http://www.xhu.edu.cn/">西华大学</a> 计算机科学与技术</li>
<li>AWS认证方案解决架构师</li>
<li>喜欢<a href="http://baike.baidu.com/view/39292.htm">史铁生</a>, <a href="https://movie.douban.com/celebrity/1012521/">David Fincher</a> 和 <a href="http://baike.baidu.com/view/2556.htm">陈奕迅</a></li>
<li>在剧组和影视公司工作过，曾参与成龙大哥电影<a href="https://movie.douban.com/subject/24529353/">《绝地逃亡》</a>制作</li>
<li>曾骑行成都-拉萨，成都-北京，海南环岛</li>
</ul>
<p>目前专注于：</p>
<ul>
<li>Cloud Native - 云解决方案</li>
<li>Serverless - 无服务器架构</li>
<li>Fintech - 金融科技</li>
<li>DevOps - 文化组织变革</li>
<li>CI/CD - 持续集成与持续交付</li>
</ul>
</div><div class="widget tags"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AWS/">AWS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Agile/">Agile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blog/">Blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDN/">CDN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Certification/">Certification</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud/">Cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud-Native/">Cloud Native</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloudfront/">Cloudfront</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DataBase/">DataBase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DevOps/">DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EC2/">EC2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTPS/">HTTPS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IAM/">IAM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Route53/">Route53</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/S3/">S3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Security/">Security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Serverless/">Serverless</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Study/">Study</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TDD/">TDD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ThoughtWorks/">ThoughtWorks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/代码/">代码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大事记/">大事记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习/">学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小结/">小结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小计/">小计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫/">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/翻译/">翻译</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/部署与发布/">部署与发布</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面试/">面试</a></li></ul></div><div class="widget archives"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">5</span></li></ul></div><div class="widget text-content"><p>该博客使用基于 &nbsp;<a href="http://hexo.io">Hexo</a>&nbsp; 的 &nbsp;<a href="https://github.com/jysperm/hexo-theme-simpleblock">simpleblock</a>&nbsp; 主题。博客内容使用 &nbsp;<a href="https://aws.amazon.com/s3/">Amazon S3</a>&nbsp; 发布。最后生成于 2017-04-08.</p></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-80279850-1', 'auto');
ga('send', 'pageview');
</script><script>window.duoshuoQuery = {short_name: 'duuyidong'}</script><script src="https://static.duoshuo.com/embed.js"></script></body></html>