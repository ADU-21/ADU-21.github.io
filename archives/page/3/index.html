<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/styles.css"><title>杜屹东的博客</title></head><body><div class="container"><div class="columns page-header"><h1>杜屹东的博客</h1></div><div class="columns"><div class="navigation"><nav class="menus-main"><a href="/" class="favicon"><img alt="杜屹东的博客" src="/favicon.png"></a><a href="/about">关于我</a><a href="/list">日志列表</a><a href="/booklist">读书</a><a href="/movie">电影</a><a href="/links">链接</a><a href="/resume">简历</a></nav><nav class="right menus-right"><a target="_blank" href="https://github.com/ADU-21/blog">Fork on Github</a></nav></div></div><div class="columns"><div class="block-body column three-fourths"><div class="article-widget"><a href="http://www.duyidong.com">小广告旗帜~~</a></div><article><header><h2><a href="/2016/11/11/一句话介绍DevOps是做什么的/">一句话介绍DevOps是做什么的</a></h2></header><div class="article-meta clearfix"><time class="left">2016 11 月 11 日</time><ul class="tags left"></ul><ul class="tags right"><li><a href="/tags/DevOps/">DevOps</a></li></ul></div><div class="markdown-body"><p>DevOps是一个很广泛的概念，他是一个运动，一种文化，强调团队紧密合作，以快速反馈的手段达到团队目标为交付最终价值的效果。<br>DevOps延伸而来有很多实践，包括：基础设施即代码，监控可视化，自动化测试，持续集成持续部署，集成配置管理等等。<br>每一种实践落实到行动上就要使用一些工具，比如基础设施及代码我们会引入很多配置管理工具，比如Ansible,puppet,chef,salt。可视化这一块可能会涉及到一些PaaS平台，比如AWS，Rancher等等。持续集成持续部署这一块主要就是一些CI 工具，Jenkins，GOCD，等等。</p>
</div></article><article><header><h2><a href="/2016/11/04/翻译-雪花服务器/">[翻译]雪花服务器</a></h2></header><div class="article-meta clearfix"><time class="left">2016 11 月 4 日</time><ul class="tags left"></ul><ul class="tags right"><li><a href="/tags/翻译/">翻译</a></li></ul></div><div class="markdown-body"><h1 id="雪花服务器"><a href="#雪花服务器" class="headerlink" title="雪花服务器"></a>雪花服务器</h1><p>原文链接: <a href="http://martinfowler.com/bliki/SnowflakeServer.html" target="_blank" rel="external">http://martinfowler.com/bliki/SnowflakeServer.html</a></p>
<p>保持生产环境服务器正常运行可能是一件非常繁琐的事，你必须保证你的操作系统和应用运行的环境被及时的修补以确保是最新版本。被托管的应用需要被经常升级。应用所处的环境也需要实时调整来配合应用有效运行即与其他系统正常通信。这些操作都依赖于命令行，GUI，或者编辑配置文件。<br><a id="more"></a><br>导致的结果就是“雪花服务器” ———— 对数据中心带来不好的影响</p>
<p>雪花服务器的第一个问题就是很难被复制。如果你的服务器硬件有问题，这就意味着你很难启动另一个服务器来提供相同的服务。如果你需要一个集群，你不能保证你启动的所有instance都是同步的。你不能复制一个产品环境来测试。当你的产品环境挂了，你将无法在你的开发测试环境重现这个错误。</p>
<p>给你的雪花服务器创建镜像或许是一个解决方案，但是镜像往往会打包很多你不需要的配置，更别说错误也会被一同打包。</p>
<p>然而，雪花服务器真正的脆弱，是在你需要改变他们的时候。雪花服务器很快就会变得难以理解和难以更改。对服务器的细微更改可能会引起一连串的连锁反应。你不确定配置的那一部分是重要的，哪些是遗留的。它的脆弱导致长时间，压力巨大的调制和debug。你需要手动流程和文档来支持你需要的更改。这也是为什么我们通常会看到很多重要的软件会运行在一个非常老旧的操作系统里。</p>
<p>避免雪花服务的一个好的方式是以某种自动化的方式掌握整个运维过程的配置。Puppet和chef都可以做到这点，你可以用修改配置文件的方式将修改应用到你所有的环境中。</p>
<p>自动化配置管理的的好处不仅是你可以重新build一个新的server，更重要的是你可以很容易知道你对一台服务器进行了什么样的配置，从而可以很容易更改。更长远的看，既然配置文件是文本格式，你可以把它纳入版本管理，就实现了基础设施即代码的好处。</p>
<p>应用部署需要遵循一个简单的准则：完全自动化，所有改变纳入版本管理。<br>通过避免雪花服务，可以带来的好处是你可以完全复制你的产品环境来进行测试，减少配置误差导致的缺陷。</p>
<p>一个很好地方式确保你不会陷入雪花服务器的困境就是使用凤凰服务。对配置进行版本管理是持续交付的重要部分。</p>
</div></article><article><header><h2><a href="/2016/11/02/翻译-凤凰式服务/">[翻译]凤凰式服务</a></h2></header><div class="article-meta clearfix"><time class="left">2016 11 月 2 日</time><ul class="tags left"></ul><ul class="tags right"><li><a href="/tags/翻译/">翻译</a></li></ul></div><div class="markdown-body"><p>原文链接： <a href="http://martinfowler.com/bliki/PhoenixServer.html" target="_blank" rel="external">http://martinfowler.com/bliki/PhoenixServer.html</a></p>
<p>有一天我突然幻想一个验证运营的服务，这个服务就是我如果跑去把公司的数据中心关掉，这毫无疑问将至我们公司的产品服务于危机之中，而这个服务的评定标准则是运营图团队需要花费多少时间能让我们的产品应用重新恢复正常。<br><a id="more"></a></p>
<p>这或许只是个幻想，但其中包含着金子一样的智慧，你完全可以尝试定期毁掉你的服务器，一个服务应该像凤凰，定期从灰烬里重生。</p>
<p>凤凰式服务首要的好处是避免配置飘移（Configuration dirft）：对操作系统指定的更改不会被记录，配置飘逸是一个巨大的泥潭，你不会希望被陷进去的。</p>
<p>一个解决配置漂移的方法就是用一个软件自动地同步服务器配置达到一个已知的统一标准。Puppet和Chef（还有Ansible和salt）两个工具都可以做到这点，不停的重复申请他们定义的资源（所以他们也可以用于实践凤凰式服务），但这些工具的局限性是他们只能控制他们定义的那一部分配置，在他们定义以外的配置漂移不会被修复。而凤凰是从无到有的，它可以覆盖所有的资源配置。</p>
<p>但这并不是说重复应用配置是无用的，毕竟它更快，破坏性也更小。他对解决配置飘移仍是有用的。</p>
<p>e.g.<br>知名网站Netflix有一个chaos monkey专门用来随机毁掉一些服务来确保他们服务的弹性（高可用性）。</p>
<p>注： 配置飘移?Configuration Dirft大意：<br>在一个生产环境的服务器中，比如一个数据库集群，由于数据库密码变动导致主从数据库不一致，或者在使用脚本去更改服务器配置的过程中让同一个环境下的服务器发生了配置不一致的情况.<br>参考链接：</p>
<ul>
<li><a href="http://kief.com/configuration-drift.html" target="_blank" rel="external">http://kief.com/configuration-drift.html</a></li>
<li><a href="http://www.continuitysoftware.com/blog/what-is-configuration-drift/" target="_blank" rel="external">http://www.continuitysoftware.com/blog/what-is-configuration-drift/</a></li>
<li><a href="https://cdn2.hubspot.net/hub/166743/file-22343462-pdf/docs/cios-guide-to-avoid-configuration-drift.pdf" target="_blank" rel="external">https://cdn2.hubspot.net/hub/166743/file-22343462-pdf/docs/cios-guide-to-avoid-configuration-drift.pdf</a></li>
</ul>
</div></article><article><header><h2><a href="/2016/10/24/部署和发布策略的演进/">部署和发布策略的演进</a></h2></header><div class="article-meta clearfix"><time class="left">2016 10 月 24 日</time><ul class="tags left"></ul><ul class="tags right"><li><a href="/tags/DevOps/">DevOps</a></li><li><a href="/tags/部署与发布/">部署与发布</a></li></ul></div><div class="markdown-body"><h1 id="持续交付的目的"><a href="#持续交付的目的" class="headerlink" title="持续交付的目的"></a>持续交付的目的</h1><h2 id="以下问题有没有解决？"><a href="#以下问题有没有解决？" class="headerlink" title="以下问题有没有解决？"></a>以下问题有没有解决？</h2><p>“快速将产品推向市场” 与 “提供稳定、安全并可靠的IT服务” 是否可以兼得？<br>用更少的资源完成更多的业绩，既要保持竞争力，又要削减成本；<br>如何解决任务交接出现的问题，例如业务与开发，开发与运维之间；<br>运维人员能否和其他人一样，正常上下班，而不用在夜里或者周末加班？</p>
<a id="more"></a>
<h1 id="部署和发布的区别"><a href="#部署和发布的区别" class="headerlink" title="部署和发布的区别"></a>部署和发布的区别</h1><p>要弄清楚部署和发布的区别，首先要弄清楚几个名词之间的关系CI(Continues Intergation)持续集成，CD(Continues Delivery)持续交付，持续集成的目的是对代码的快速反馈，在分布式开发的团队中你的更改不会破坏已有代码功能，持续交付的scope要大一些，指的是对用户交付最终价值，传统的交付最终价值即为产生可发布的版本，有的公司在持续交付的基础之上甚至提出了持续部署（Continous Deployment），即自动化讲可发布版本放入到产品环境，其中就涉及到蓝绿部署，滚动部署等部署方式。在部署和发布解耦之后，在将产品部署到产品环境之后我们可能还有些功能是不想对用户可见的，在对用户可见的的这个过程我们称之为发布（Release）（如图）。DevOps运动则是在发布之后有引入运维和运营的角色，和用户反馈一起形成一个闭环。恩，差不多是这个样子的。    </p>
<p><img src="https://puppet.com/sites/default/files/2016-09/puppet_continuous_diagram.gif" alt=""></p>
<p>ThoughtWorks在15年的技术雷达上已经建议解耦部署和发布:</p>
<pre><code class="我们推荐严格区分术语“部署（Deployment）”和“发布（Release）”的使用。应用组件或基本设施的代码或配置变更在产品环境生效称为“部署”，而具有业务影响的功能变化对最终用户可见称为“发布”。使用特性开关或灰度发布等技巧可以使我们更加频繁地部署变更到产品环境但并不发布功能。频繁部署可以有效降低变更带来的风险，同时业务负责人仍然能保持何时向最终用户发布功能的控制。```">
# 零宕机发布（目标）
```零宕机发布指的一种将用户从一个版本几乎瞬间转移到另一个版本上的方法，更重要的是，如果出了什么问题，他还要能在瞬间把用户从这个版本转回到原先的版本上。
</code></pre>
<p>零宕机发布的关键在于将发布流程中不同的部分解耦，尽量使他们能独立发生。</p>
<h1 id="凤凰式部署"><a href="#凤凰式部署" class="headerlink" title="凤凰式部署"></a>凤凰式部署</h1><p>将产品环境和应用打包发布，在容器产生之前是将系统和应用制作镜像的方式进行发布，避免产品环境和非生产环境不一致导致发布失败，但是这种发布方式因为笨重而被容器取代。</p>
<ul>
<li>便于回滚</li>
<li>提高计算资源的利用率：相对以操作系统为计算单元的管理方式，容器不仅更轻量而且极大提高了计算资源的利用率，且容器本身不占用计算资源。而且相对image的方式，管理成本，备份的cost也极大降低</li>
<li>更快的部署时间：image的方式需要一天，snapshot需要十分钟，Container则可以把这个时间缩短到秒级</li>
<li>解决了环境不一致的问题</li>
<li>跨平台</li>
<li>prodocut team over project team:每个team可以更方便的管理自己的platform资源，极大地降低了team之间的沟通成本。（相对application team和platfor team分离的情况）</li>
</ul>
<p>风险：安全，容器必须是以root权限泡在宿主机上，不同容器共享一个宿主机，如果一个容器被贡献则会威胁到所有在改宿主机上的服务。<br>解决方案：</p>
<ul>
<li>及时更新宿主机系统版本，避免内核漏洞</li>
<li>扫描bese image, 避免Container本身系统漏洞</li>
<li>base image可以加入主动防御（e.g.ossec）</li>
<li>控制好容器操作权限</li>
</ul>
<h1 id="滚动发布-Rolling-Release"><a href="#滚动发布-Rolling-Release" class="headerlink" title="滚动发布(Rolling Release)"></a>滚动发布(Rolling Release)</h1><p>又称滚动更新(rolling update)<br>指的是在不切换负载均衡器或者DNS的前提下把负载均衡器下的机器一台台关掉，部署好之后再挂到负载均衡器下面，与蓝绿部署直观的差别是不需要切换负载均衡器或DNS，同时做到零宕机部署。（还要完善）</p>
<h1 id="蓝绿部署（BuleGreen-Deployment）"><a href="#蓝绿部署（BuleGreen-Deployment）" class="headerlink" title="蓝绿部署（BuleGreen Deployment）"></a>蓝绿部署（BuleGreen Deployment）</h1><p>在发布之前就把应用程序放在产品环境上部署好，如果“发布”能像重新配置一下路由器那样简单，让他直接指向生产环境，那就更好了 ————《持续交付》<br>蓝绿部署主要解决的是宕机发布的问题<br>它的主要原理是在保持旧版本环境（绿环境）正常运行的情况下，准备一套蓝环境，在产品环境里蓝环境通过充分冒烟测试后再将用户访问从绿环境切换到蓝环境，如果蓝环境在这个切换之后出现问题则立即切换回绿环境，如果没有问题则最后destroy掉绿环境，具体做法可以通过DNS或者ELB配合AutoScaling Group进行Infrastructure的切换，这种切换通常在一秒之内就可以搞定。application层的回话切换以及数据库链接切换的问题，可以使用中间件解决。</p>
<p><img src="http://martinfowler.com/bliki/images/blueGreenDeployment/blue_green_deployments.png" alt=""></p>
<p>对于数据库，直接从绿环境切换到蓝环境是不可能的，因为如果数据库结构发生改变的话，数据迁移需要时间。解决这种情况最理想的方法是在一小段时间把数据库变成只读状态，完成迁移后再将用户切换到蓝环境，恢复读写。如果在切换过程中仍然有数据的写入，你可以采用添加中间件的方式保存读写数据，或者在在读写过程中持续将事物发向新旧两个数据库。<br></p>
<h1 id="灰度发布（金丝雀发布）"><a href="#灰度发布（金丝雀发布）" class="headerlink" title="灰度发布（金丝雀发布）"></a>灰度发布（金丝雀发布）</h1><p>在把应用程序发布给所有人之前，先试着把它发布给一小撮用户群，这种技术叫做金丝雀发布。<br>金丝雀发布要解决的问题主要是缩短反馈周期，以及弥补巨大产品环境下无法进行有效容量测试所可能导致的问题的一种手段。是一个能大大降低新版本发布风险的方法。<br>灰度发布是蓝绿部署的一个延伸，采用逐步切换的方式使新版本发布只影响到尽可能少的用户，从而为AB测试提供条件。灰度发布<br>灰度发布与金丝雀部署在操作上是等价的<br>金丝雀发有以下几个好处：</p>
<ul>
<li>非常容易回滚，这个其实是蓝绿部署就已经带来的好处，只要不把用户引向有问题的新版本，就可以有足够的时间用来分析错误日志，排查问题。</li>
<li>可以将同一批用户引至不新旧版本以进行A/B测试，某些公司可以度量新特性的使用率，某些公司可以度量该版本带来的收益，你不必将大量用户引入A/B测试，只需要有代表性的样本就足够了。</li>
<li>可以通过逐渐增加负载，记录并衡量应用程序响应时间，CPU使用率，I/O，内存使用率以及日志中是否有异常报告这种方式来检查应用程序是否满足容量需求，降低容量测试不理想带来的风险。</li>
</ul>
<p>另外，需要注意的是，在生产环境中保留尽可能少的版本也是非常重要的，最好限制在两个版本之内。</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><ul>
<li>紧急修复：一定不要破坏流程，不要直接对生产环境进行修改。</li>
<li>持续部署：If it hurts, do it more often</li>
<li>持续发布用户自行安装的软件？发布方式？</li>
<li>执行部署的人应该参与部署过程的创建（Dev和Ops的紧密合作）</li>
<li>记录部署活动（自动化更佳）</li>
<li>不要删除旧文件，而是移动到别的位置。在Unix环境中，一个最佳实践是把每个版本部署到不同的文件夹中，创建一个符号链接文件指向最新版本，版本的部署和回滚就只是改一下符号链接这么简单。</li>
<li>部署是整个团队的责任（DevOps）</li>
<li>快速失败，部署脚本也应该纳入测试中，这些测试应该被作为部署的一部分来工作。</li>
<li>数据库最好向前兼容</li>
</ul>
</div></article><div class="archive-pagination"><div class="paginator"><a class="extend prev" rel="prev" href="/archives/page/2/">&laquo;</a><a class="page-number" href="/archives/">1</a><a class="page-number" href="/archives/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/archives/page/4/">4</a><a class="page-number" href="/archives/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/archives/page/9/">9</a><a class="extend next" rel="next" href="/archives/page/4/">&raquo;</a></div></div></div><div class="block-sidebar column one-fourth"><div class="widget text-content"><p>杜屹东 生于 1993.12.16, 英文 ID Luke Du</p>
<ul>
<li>现就职于<a href="https://www.thoughtworks.com/">ThoughtWorks</a></li>
<li>毕业于 <a href="http://www.xhu.edu.cn/">西华大学</a> 计算机科学与技术</li>
<li>喜欢<a href="http://baike.baidu.com/view/39292.htm">史铁生</a>, <a href="https://movie.douban.com/celebrity/1012521/">David Fincher</a> 和 <a href="http://baike.baidu.com/view/2556.htm">陈奕迅</a></li>
<li>在剧组和影视公司工作过，对影视前后期工作略知一二，曾参与成龙大哥电影<a href="https://movie.douban.com/subject/24529353/">《绝地逃亡》</a>制作</li>
<li>曾骑行成都-拉萨，成都-北京，海南环岛</li>
</ul>
<p>目前专注于：</p>
<ul>
<li>AWS - 认证考试</li>
<li>DevOps - 文化组织变革</li>
<li>CI/CD - 持续集成与持续交付</li>
<li>Agile - 敏捷文化</li>
</ul>
</div><div class="widget tags"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AWS/">AWS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Agile/">Agile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DataBase/">DataBase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DevOps/">DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EC2/">EC2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IAM/">IAM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/S3/">S3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Security/">Security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Serverless/">Serverless</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Study/">Study</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TDD/">TDD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ThoughtWorks/">ThoughtWorks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/代码/">代码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大事记/">大事记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习/">学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小结/">小结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小计/">小计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫/">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/翻译/">翻译</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/部署与发布/">部署与发布</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面试/">面试</a></li></ul></div><div class="widget archives"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">5</span></li></ul></div><div class="widget text-content"><p>该博客使用基于 &nbsp;<a href="http://hexo.io">Hexo</a>&nbsp; 的 &nbsp;<a href="https://github.com/jysperm/hexo-theme-simpleblock">simpleblock</a>&nbsp; 主题。博客内容使用 &nbsp;<a href="https://aws.amazon.com/s3/">Amazon S3</a>&nbsp; 发布。最后生成于 2017-03-17.</p></div></div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-80279850-1', 'auto');
ga('send', 'pageview');
</script><script>window.duoshuoQuery = {short_name: 'duuyidong'}</script><script src="https://static.duoshuo.com/embed.js"></script></body></html>